@if (data$ | async; as data) {
    <app-layout (discardFilters)="removeAllFilters()" (applyFilters)="applyFilters(data)">
        <div [formGroup]="form">
            <div [formArrayName]="'events'">
                @for (eventControl of events.controls; track eventControl; let i = $index) {
                    @let typeId = eventControl.get("type")?.value?.toString();
                    @let typeData = typeId ? data.events[+typeId] : null;
                    <div class="event-control" [formGroupName]="i">
                        <app-step-header
                            [stepNumber]="i + 1"
                            [stepName]="typeData?.type || 'Unnamed step'"
                            (copy)="copyEvent(i)"
                            (delete)="deleteEvent(i)"
                        >
                        </app-step-header>
                        <div class="step-content">
                            <select [formControlName]="'type'">
                                <option value=""></option>
                                @for (item of data.events; track $index; let idx = $index) {
                                    <option [value]="idx">{{ item.type }}</option>
                                }
                            </select>
                            <div formArrayName="properties">
                                @let properties = $any(eventControl.get("properties"));
                                @for (propControl of properties.controls; track propControl; let j = $index) {
                                    <div class="prop-controls" [formGroupName]="j">
                                        @if (j > 0) {
                                            <span class="and-text">AND</span>
                                        }
                                        <select [formControlName]="'property'">
                                            @let propOptions = typeId ? data.events[+typeId].properties || [] : [];
                                            @for (item of propOptions; track $index; let idx = $index) {
                                                <option [value]="idx">{{ item.property }}</option>
                                            }
                                        </select>
                                        @if (propControl.get("property")?.value !== "") {
                                            <app-filter-dropdown
                                                [activeFilterOption]="propControl.get('optionToDisplay')?.value"
                                                [activeFilterType]="propControl.get('typeToDisplay')?.value"
                                                (selectionChange)="setOption(propControl, $event)"
                                            />
                                        }
                                        <div formArrayName="options">
                                            @let options = $any(propControl.get("options"));
                                            @for (optionControl of options.controls; track optionControl; let k = $index; let last = $last) {
                                                <div class="option-controls" [formGroupName]="k">
                                                    <input class="inline-input" type="text" formControlName="value" />
                                                    @if (!last) {
                                                        <span class="and-text-between">and</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <button class="btn btn-small btn-icon" (click)="deleteProp(properties, j)">
                                            <img src="assets/cross-small-svgrepo-com.svg" alt="Delete" />
                                        </button>
                                    </div>
                                }
                                @if (typeId !== "") {
                                    <button class="btn btn-small" (click)="addProp(eventControl)">+ Add Property</button>
                                }
                            </div>
                        </div>
                    </div>
                    <div class="separator"></div>
                }
            </div>
        </div>
        @if (data.events.length > 0) {
            <div class="center-button"><button class="btn btn-medium" (click)="addEvent()">+ ADD FUNNEL STEP</button></div>
        }
    </app-layout>
}
